<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>WW1 Trench Assault – Objective Mode</title>
  <style>
    body { margin:0; background:#0b0b0b; overflow:hidden; }
    canvas { display:block; margin:auto; background:#141414; }
    #ui { position:fixed; top:10px; left:10px; color:#fff; font-family:Arial,sans-serif; font-size:14px; }
    #overlay { position:fixed; inset:0; background:rgba(0,0,0,0.8); color:#fff; display:none; align-items:center; justify-content:center; flex-direction:column; font-family:Arial; }
    button { padding:12px 22px; font-size:16px; cursor:pointer; }
  </style>
</head>
<body>
<div id="ui">
  <div>WASD Move | Mouse Aim | Click Shoot | R Reload | F Bayonet | G Grenade | 1–4 Weapons</div>
  <div id="stats"></div>
</div>
<div id="overlay">
  <h1 id="overlayText"></h1>
  <button onclick="restart()">Restart Battle</button>
</div>
<canvas id="game" width="1100" height="720"></canvas>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
const stats = document.getElementById('stats');
const overlay = document.getElementById('overlay');
const overlayText = document.getElementById('overlayText');

// HUGE WORLD
const world = { width: 9000, height: 4200 };

// PLAYER
let player;
function createPlayer(){
  return { x:900, y:world.height/2, hp:100, speed:3, angle:0, gun:1, team:'blue', alive:true, grenades:4, ammo:5, maxAmmo:5, reloading:false, reloadTime:0 };
}
player = createPlayer();

// WEAPONS
const guns = [
  { name:'Pistol', rate:420, speed:8, damage:18, reload:120, ammo:8 },
  { name:'Rifle', rate:120, speed:12, damage:10, reload:160, ammo:5 },
  { name:'Rocket', rate:900, speed:6, damage:60, explosive:true, reload:240, ammo:1 },
  { name:'Musket', rate:1400, speed:10, damage:40, spread:0.18, smoke:true, reload:280, ammo:1 }
];

let bullets=[], explosions=[], soldiers=[], blood=[], grenades=[], smoke=[], clouds=[], cannons=[], tanks=[];
let lastShot=0;

// INPUT
const keys={};
window.addEventListener('keydown',e=>{ keys[e.key.toLowerCase()]=true; if(e.key.toLowerCase()==='r') reload(); if(e.key.toLowerCase()==='f') bayonet(); if(e.key.toLowerCase()==='g') throwGrenade(); if(e.key>='1'&&e.key<='4') switchGun(Number(e.key)-1); });
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
window.addEventListener('mousemove',e=>{ const r=canvas.getBoundingClientRect(); player.angle=Math.atan2(e.clientY-r.top-canvas.height/2, e.clientX-r.left-canvas.width/2); });
window.addEventListener('mousedown',shoot);

function switchGun(i){ player.gun=i; player.maxAmmo=guns[i].ammo; player.ammo=player.maxAmmo; }

function shoot(){
  if(!player.alive||player.reloading||player.ammo<=0) return;
  const g=guns[player.gun]; const now=performance.now(); if(now-lastShot<g.rate) return; lastShot=now;
  player.ammo--;
  const ang=player.angle+(g.spread?(Math.random()*2-1)*g.spread:0);
  bullets.push({ x:player.x,y:player.y,vx:Math.cos(ang)*g.speed,vy:Math.sin(ang)*g.speed,damage:g.damage,team:player.team,explosive:g.explosive });
  if(g.smoke) for(let i=0;i<12;i++) smoke.push({x:player.x,y:player.y,vx:(Math.random()*2-1),vy:(Math.random()*2-1),life:50});
}

function reload(){ if(player.reloading||player.ammo===player.maxAmmo) return; player.reloading=true; player.reloadTime=guns[player.gun].reload; }

function bayonet(){
  soldiers.forEach(s=>{ if(s.alive&&s.team!==player.team&&Math.hypot(s.x-player.x,s.y-player.y)<32){ s.alive=false; splatter(s.x,s.y,30); } });
}

function throwGrenade(){ if(player.grenades<=0||!player.alive) return; player.grenades--; grenades.push({ x:player.x,y:player.y,vx:Math.cos(player.angle)*5,vy:Math.sin(player.angle)*5,fuse:100,team:player.team }); }

// SOLDIERS – 90 PER TEAM
function spawnSoldier(team,x){ soldiers.push({ x,y:world.height/2+(Math.random()*400-200), hp:60, team, alive:true, fall:0, rot:0, vr:(Math.random()*0.2+0.05)*(Math.random()<0.5?-1:1), ammo:3, reload:0 }); }
for(let i=0;i<90;i++){ spawnSoldier('blue',700+Math.random()*400); spawnSoldier('red',world.width-700-Math.random()*400); }

// CANNONS – 8 PER TRENCH
for(let i=0;i<8;i++){
  cannons.push({ x:900+i*180, y:world.height/2-160, team:'blue', cd:Math.random()*120 });
  cannons.push({ x:world.width-900-i*180, y:world.height/2+160, team:'red', cd:Math.random()*120 });
}

// TANKS
function spawnTank(team,x){ tanks.push({ x,y:world.height/2+(Math.random()*600-300), hp:300, team, dir:team==='blue'?1:-1 }); }
spawnTank('blue',1200); spawnTank('blue',1500);
spawnTank('red',world.width-1200); spawnTank('red',world.width-1500);

// CLOUDS
for(let i=0;i<40;i++) clouds.push({ x:Math.random()*world.width, y:Math.random()*600, s:0.2+Math.random()*0.3 });

function splatter(x,y,c){ for(let i=0;i<c;i++) blood.push({ x,y,vx:(Math.random()*2-1)*3,vy:(Math.random()*2-1)*3,life:50 }); }

function explode(x,y,r,team){ explosions.push({x,y,r:12,life:16}); splatter(x,y,40); soldiers.forEach(s=>{ if(s.alive&&s.team!==team&&Math.hypot(s.x-x,s.y-y)<r){ s.alive=false; splatter(s.x,s.y,50);} }); }

// OBJECTIVE ZONES (TRENCHES)
const blueTrench = { x:800, w:600 };
const redTrench = { x:world.width-1400, w:600 };

function checkWin(){
  if(player.x>redTrench.x && player.x<redTrench.x+redTrench.w){ overlayText.innerText='BLUE TEAM CAPTURED THE RED TRENCH'; overlay.style.display='flex'; }
  if(player.x<blueTrench.x+blueTrench.w && player.team==='red'){ overlayText.innerText='RED TEAM CAPTURED THE BLUE TRENCH'; overlay.style.display='flex'; }
}

function restart(){ bullets=[]; explosions=[]; soldiers=[]; blood=[]; grenades=[]; smoke=[]; tanks=[]; overlay.style.display='none'; player=createPlayer(); for(let i=0;i<90;i++){ spawnSoldier('blue',700+Math.random()*400); spawnSoldier('red',world.width-700-Math.random()*400); } spawnTank('blue',1200); spawnTank('blue',1500); spawnTank('red',world.width-1200); spawnTank('red',world.width-1500); }

function update(){
  if(player.alive){ if(keys['w'])player.y-=player.speed; if(keys['s'])player.y+=player.speed; if(keys['a'])player.x-=player.speed; if(keys['d'])player.x+=player.speed; }

  if(player.reloading){ player.reloadTime--; if(player.reloadTime<=0){ player.reloading=false; player.ammo=player.maxAmmo; } }

  bullets.forEach(b=>{ b.x+=b.vx; b.y+=b.vy; });

  soldiers.forEach(s=>{
    if(!s.alive){ s.fall=Math.min(20,s.fall+0.9); s.rot+=s.vr; return; }
    s.x+=(s.team==='blue'?1:-1)*1.0;
    if(Math.random()<0.01 && s.ammo>0){ s.ammo--; bullets.push({ x:s.x,y:s.y,vx:(s.team==='blue'?1:-1)*6,vy:0,damage:8,team:s.team }); }
    if(s.ammo<=0){ s.ammo=3; }
  });

  cannons.forEach(c=>{ c.cd--; if(c.cd<=0){ c.cd=120; bullets.push({ x:c.x,y:c.y,vx:(c.team==='blue'?1:-1)*9,vy:0,damage:80,team:c.team,explosive:true }); } });

  tanks.forEach(t=>{ t.x+=t.dir*0.4; if(Math.random()<0.01) bullets.push({ x:t.x,y:t.y,vx:t.dir*8,vy:0,damage:50,team:t.team,explosive:true }); });

  grenades.forEach((g,i)=>{ g.x+=g.vx; g.y+=g.vy; g.vx*=0.98; g.vy*=0.98; g.fuse--; if(g.fuse<=0){ explode(g.x,g.y,120,g.team); grenades.splice(i,1); } });

  bullets.forEach((b,bi)=>{
    soldiers.forEach(s=>{ if(s.alive&&s.team!==b.team&&Math.hypot(b.x-s.x,b.y-s.y)<10){ s.alive=false; splatter(s.x,s.y,25); if(b.explosive) explode(s.x,s.y,120,b.team); bullets.splice(bi,1); } });
    if(player.alive&&b.team!==player.team&&Math.hypot(b.x-player.x,b.y-player.y)<12){ player.hp-=b.damage; splatter(player.x,player.y,20); bullets.splice(bi,1); if(player.hp<=0){ overlayText.innerText='YOU DIED'; overlay.style.display='flex'; } }
  });

  explosions.forEach(e=>{ e.r+=6; e.life--; }); explosions=explosions.filter(e=>e.life>0);
  blood.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vx*=0.9; p.vy*=0.9; p.life--; }); blood=blood.filter(p=>p.life>0);
  smoke.forEach(s=>{ s.x+=s.vx; s.y+=s.vy; s.life--; }); smoke=smoke.filter(s=>s.life>0);
  clouds.forEach(c=>{ c.x+=c.s; if(c.x>world.width) c.x=0; });

  checkWin();

  stats.innerText=`HP:${player.hp} | ${guns[player.gun].name} | Ammo:${player.ammo}/${player.maxAmmo} | Grenades:${player.grenades} | Blue:${soldiers.filter(s=>s.team==='blue'&&s.alive).length} Red:${soldiers.filter(s=>s.team==='red'&&s.alive).length}`;
}

function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  const camX=player.x-canvas.width/2, camY=player.y-canvas.height/2;

  // CLOUDY SKY
  ctx.fillStyle='#1b1b1b'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='rgba(200,200,200,0.12)'; clouds.forEach(c=>{ ctx.beginPath(); ctx.arc(c.x-camX,c.y-camY,120,0,Math.PI*2); ctx.fill(); });

  // TREES
  for(let i=0;i<world.width;i+=300){ ctx.fillStyle='#1f2b1f'; ctx.fillRect(i-camX,world.height/2-400-camY,20,120); }

  // TRENCHES
  ctx.fillStyle='#2b1d12';
  ctx.fillRect(blueTrench.x-camX,world.height/2-200-camY,blueTrench.w,120);
  ctx.fillRect(redTrench.x-camX,world.height/2+80-camY,redTrench.w,120);

  // BLOOD
  ctx.fillStyle='darkred'; blood.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x-camX,p.y-camY,2,0,Math.PI*2); ctx.fill(); });

  // PLAYER
  if(player.alive){ ctx.save(); ctx.translate(player.x-camX,player.y-camY); ctx.rotate(player.angle); ctx.fillStyle='#4caf50'; ctx.fillRect(-10,-10,28,20); ctx.restore(); }

  // SOLDIERS
  soldiers.forEach(s=>{ ctx.save(); ctx.translate(s.x-camX,s.y-camY+s.fall); ctx.rotate(s.rot); ctx.fillStyle=s.team==='blue'?'#2196f3':'#b71c1c'; ctx.fillRect(-8,-8,16,16); ctx.restore(); });

  // CANNONS
  cannons.forEach(c=>{ ctx.fillStyle='#555'; ctx.fillRect(c.x-24-camX,c.y-10-camY,48,20); });

  // TANKS
  tanks.forEach(t=>{ ctx.fillStyle='#3a3a3a'; ctx.fillRect(t.x-30-camX,t.y-16-camY,60,32); });

  // BULLETS
  ctx.fillStyle='#ffeb3b'; bullets.forEach(b=>{ ctx.beginPath(); ctx.arc(b.x-camX,b.y-camY,3,0,Math.PI*2); ctx.fill(); });

  // GRENADES
  ctx.fillStyle='#4e4e4e'; grenades.forEach(g=>{ ctx.beginPath(); ctx.arc(g.x-camX,g.y-camY,5,0,Math.PI*2); ctx.fill(); });

  // EXPLOSIONS
  explosions.forEach(e=>{ ctx.strokeStyle='orange'; ctx.beginPath(); ctx.arc(e.x-camX,e.y-camY,e.r,0,Math.PI*2); ctx.stroke(); });
}

function loop(){ update(); draw(); requestAnimationFrame(loop); }
loop();
</script>
</body>
</html>
